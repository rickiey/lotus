Index: chain/messagepool/config.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- chain/messagepool/config.go	(revision 5c56017dbb6385bfaa63c0a22caaff9798fa3baa)
+++ chain/messagepool/config.go	(revision 40f43551fe158b68ae180c6ddb3321fc90fded5e)
@@ -15,7 +15,8 @@
 	MemPoolSizeLimitHiDefault = 30000
 	MemPoolSizeLimitLoDefault = 20000
 	PruneCooldownDefault      = time.Minute
-	GasLimitOverestimation    = 1.25
+	//GasLimitOverestimation    = 1.25
+	GasLimitOverestimation = 1.27
 
 	ConfigKey = datastore.NewKey("/mpool/config")
 )
Index: node/config/def.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- node/config/def.go	(revision 5c56017dbb6385bfaa63c0a22caaff9798fa3baa)
+++ node/config/def.go	(revision 40f43551fe158b68ae180c6ddb3321fc90fded5e)
@@ -205,7 +205,9 @@
 
 }
 
-var DefaultDefaultMaxFee = types.MustParseFIL("0.007")
+// 默认最大支付手续费0.007，增加到 0.008
+//var DefaultDefaultMaxFee = types.MustParseFIL("0.007")
+var DefaultDefaultMaxFee = types.MustParseFIL("0.008")
 var DefaultSimultaneousTransfers = uint64(20)
 
 // DefaultFullNode returns the default config
@@ -265,13 +267,21 @@
 			MaxProviderCollateralMultiplier: 2,
 		},
 
+		//Fees: MinerFeeConfig{
+		//	MaxPreCommitGasFee:     types.MustParseFIL("0.025"),
+		//	MaxCommitGasFee:        types.MustParseFIL("0.05"),
+		//	MaxTerminateGasFee:     types.MustParseFIL("0.5"),
+		//	MaxWindowPoStGasFee:    types.MustParseFIL("5"),
+		//	MaxPublishDealsFee:     types.MustParseFIL("0.05"),
+		//	MaxMarketBalanceAddFee: types.MustParseFIL("0.007"),
+		//},
 		Fees: MinerFeeConfig{
-			MaxPreCommitGasFee:     types.MustParseFIL("0.025"),
-			MaxCommitGasFee:        types.MustParseFIL("0.05"),
-			MaxTerminateGasFee:     types.MustParseFIL("0.5"),
+			MaxPreCommitGasFee:     types.MustParseFIL("0.03"),
+			MaxCommitGasFee:        types.MustParseFIL("0.08"),
+			MaxTerminateGasFee:     types.MustParseFIL("0.6"),
 			MaxWindowPoStGasFee:    types.MustParseFIL("5"),
-			MaxPublishDealsFee:     types.MustParseFIL("0.05"),
-			MaxMarketBalanceAddFee: types.MustParseFIL("0.007"),
+			MaxPublishDealsFee:     types.MustParseFIL("0.08"),
+			MaxMarketBalanceAddFee: types.MustParseFIL("0.008"),
 		},
 
 		Addresses: MinerAddressConfig{
Index: node/impl/full/gas.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- node/impl/full/gas.go	(revision 5c56017dbb6385bfaa63c0a22caaff9798fa3baa)
+++ node/impl/full/gas.go	(revision 40f43551fe158b68ae180c6ddb3321fc90fded5e)
@@ -17,6 +17,8 @@
 	"github.com/filecoin-project/go-state-types/big"
 	"github.com/filecoin-project/go-state-types/exitcode"
 
+	builtin3 "github.com/filecoin-project/specs-actors/v3/actors/builtin"
+
 	"github.com/filecoin-project/lotus/api"
 	"github.com/filecoin-project/lotus/build"
 	"github.com/filecoin-project/lotus/chain/messagepool"
@@ -282,12 +284,29 @@
 }
 
 func (m *GasModule) GasEstimateMessageGas(ctx context.Context, msg *types.Message, spec *api.MessageSendSpec, _ types.TipSetKey) (*types.Message, error) {
+
+	// 默认 1.25， 如果是 WindowPoSt 改为 1.0999
+	gasLimitOverestimation := m.Mpool.GetConfig().GasLimitOverestimation
+
+	// 默认 20， 增加到 22， WindowPoSt 增加到 24
+	// maxqueueblks := 20
+	maxqueueblks := int64(22)
+
+	// 3000 nanoFIL
+	maxMinerTip := types.NewInt(3000_000_000_000)
+
+	// 简单判断下是不是 WindowPoSt 消息
+	if msg.To.Protocol() == address.ID && msg.Method == builtin3.MethodsMiner.SubmitWindowedPoSt {
+		gasLimitOverestimation = 1.0999
+		maxqueueblks = 24
+	}
+
 	if msg.GasLimit == 0 {
 		gasLimit, err := m.GasEstimateGasLimit(ctx, msg, types.TipSetKey{})
 		if err != nil {
 			return nil, xerrors.Errorf("estimating gas used: %w", err)
 		}
-		msg.GasLimit = int64(float64(gasLimit) * m.Mpool.GetConfig().GasLimitOverestimation)
+		msg.GasLimit = int64(float64(gasLimit) * gasLimitOverestimation)
 	}
 
 	if msg.GasPremium == types.EmptyInt || types.BigCmp(msg.GasPremium, types.NewInt(0)) == 0 {
@@ -295,11 +314,18 @@
 		if err != nil {
 			return nil, xerrors.Errorf("estimating gas price: %w", err)
 		}
-		msg.GasPremium = gasPremium
+
+		// gas Premium 增加 25%
+		msg.GasPremium = types.BigAdd(gasPremium, types.BigDiv(gasPremium, types.NewInt(4)))
+
+		// 设置最大 MinerTip, 防止天价矿工费
+		if types.BigCmp(msg.GasPremium, types.BigDiv(maxMinerTip, types.NewInt(uint64(msg.GasLimit)))) >= 0 {
+			msg.GasPremium = types.BigDiv(maxMinerTip, types.NewInt(uint64(msg.GasLimit)))
+		}
 	}
 
 	if msg.GasFeeCap == types.EmptyInt || types.BigCmp(msg.GasFeeCap, types.NewInt(0)) == 0 {
-		feeCap, err := m.GasEstimateFeeCap(ctx, msg, 20, types.EmptyTSK)
+		feeCap, err := m.GasEstimateFeeCap(ctx, msg, maxqueueblks, types.EmptyTSK)
 		if err != nil {
 			return nil, xerrors.Errorf("estimating fee cap: %w", err)
 		}
